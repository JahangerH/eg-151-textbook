<!DOCTYPE html>
<html lang="en"><head>
<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/tabby.min.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-dark-2b3e328b71be8d25427581baeb23079b.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.7.30">

  <meta name="author" content="Ben Clifford">
  <meta name="dcterms.date" content="2024-11-05">
  <title>Interfacing to Analogue I/O with C</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #f8f8f2;  }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #f8f8f2; } /* Normal */
    code span.al { color: #f07178; } /* Alert */
    code span.an { color: #d4d0ab; } /* Annotation */
    code span.at { color: #00e0e0; } /* Attribute */
    code span.bn { color: #d4d0ab; } /* BaseN */
    code span.bu { color: #abe338; } /* BuiltIn */
    code span.cf { color: #ffa07a; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #abe338; } /* Char */
    code span.cn { color: #ffd700; } /* Constant */
    code span.co { color: #f8f8f2; font-style: italic; } /* Comment */
    code span.cv { color: #ffd700; } /* CommentVar */
    code span.do { color: #f8f8f2; } /* Documentation */
    code span.dt { color: #ffa07a; } /* DataType */
    code span.dv { color: #d4d0ab; } /* DecVal */
    code span.er { color: #f07178; text-decoration: underline; } /* Error */
    code span.ex { color: #00e0e0; font-weight: bold; } /* Extension */
    code span.fl { color: #d4d0ab; } /* Float */
    code span.fu { color: #ffa07a; } /* Function */
    code span.im { color: #abe338; } /* Import */
    code span.in { color: #d4d0ab; } /* Information */
    code span.kw { color: #ffa07a; font-weight: bold; } /* Keyword */
    code span.op { color: #ffa07a; } /* Operator */
    code span.ot { color: #00e0e0; } /* Other */
    code span.pp { color: #dcc6e0; } /* Preprocessor */
    code span.re { color: #00e0e0; background-color: #f8f8f2; } /* RegionMarker */
    code span.sc { color: #abe338; } /* SpecialChar */
    code span.ss { color: #abe338; } /* SpecialString */
    code span.st { color: #abe338; } /* String */
    code span.va { color: #00e0e0; } /* Variable */
    code span.vs { color: #abe338; } /* VerbatimString */
    code span.wa { color: #dcc6e0; } /* Warning */
  </style>
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/theme/quarto-091ebfb71d12db7fc524ec91495e1509.css">
  <link href="index_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-dark">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" data-background-image="../../pictures/image1.png" data-background-opacity="0.9" data-background-size="contain" class="quarto-title-block center">
  <h1 class="title">Interfacing to Analogue I/O with C</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Ben Clifford 
</div>
        <p class="quarto-title-affiliation">
            Welsh Centre for Printing and Coatings
          </p>
    </div>
</div>

  <p class="date">2024-11-05</p>
</section>
<section class="slide level2">

<aside class="notes">
<p><a href=".\slides/lecture07.html">Presentation version</a> of these <a href="#/sec-week06-intro">notes</a>.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>

<img data-src="pictures/week06_chapter_heading.png" style="width:100.0%" alt="lecture cover image showing architecture, some gates and an Arduino nano board" class="r-stretch"></section>
<section id="sec-wk6-intro" class="slide level2 unnumbered">
<h2>Introduction</h2>
<p>C is a high-level structured programming language which is often used for writing microcontroller applications. This lecture looks at how I/O operations are performed on analogue inputs.</p>
</section>
<section id="lecture-topics" class="slide level2 unnumbered">
<h2>Lecture topics</h2>
<div class="columns">
<div class="column" style="width:25%;">
<p><img data-src="pictures/week06_contents_image.png" alt="Decorative image used as a slide background."></p>
</div><div class="column" style="width:75%;">
<ul>
<li><a href="#/sec-wk6-sect1" class="quarto-xref">Section&nbsp;1</a>: <a href="#/sec-wk6-sect1">What are analogue signals?</a></li>
<li><a href="#/sec-wk6-sect2" class="quarto-xref">Section&nbsp;2</a>: <a href="#/sec-wk6-sect2">ADC Architecture</a></li>
<li><a href="#/sec-wk6-sect3" class="quarto-xref">Section&nbsp;3</a>: <a href="#/sec-wk6-sect3">The Atmel ATmega328 Analog-digital-converter</a></li>
<li><a href="#/sec-wk6-sect4" class="quarto-xref">Section&nbsp;4</a>: <a href="#/sec-wk6-sect4">Analogue I/O Example program</a></li>
</ul>
</div></div>
</section>
<section class="slide level2">

<h3 class="unnumbered" id="outline">Outline</h3>
<p>In this lecture we will be looking at how we can read analogue signals into a microcontroller using an analogue to digital converter (ADC).</p>
<ul>
<li class="fragment">We begin by introducing analogue signals and the fundamental principals of an ADC.</li>
<li class="fragment">We move on to look at the ADC contained on the Atmel ATmega328 microcontroller, focussing on the key registers and how to use them.</li>
<li class="fragment">We conclude with an example program for the Atmel ATmega328 microcontroller which reads the voltage from a potentiometer and turns on some LEDs based on the voltage.</li>
</ul>
</section>
<section id="sec-wk6-sect1" class="slide level2 center" data-background-image="pictures/waves_wallpaper.jpg">
<h2>What are analogue signals?</h2>
</section>
<aside class="notes">
<p><img data-src="pictures/waves_wallpaper.jpg" alt="Decorative image of some analogue waveforms."></p>
<p><a href="https://paperpcb.dernulleffekt.de/doku.php?id=analog_computer:confetti703_multiplier">This image</a> by Unknown Author <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC-BY-SA-NC</a>.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
<section class="slide level2">

<h3 id="analogue-signals">Analogue signals</h3>
<p>Analogue signals are those that are both continuous in time and continuous in amplitude i.e.&nbsp;they are continuous signals.</p>
<p>In the real world, most measurable parameters are actually analogue. They include such signals as temperature, humidity, light, sound, etc.</p>
</section>
<section class="slide level2">

<h4 class="unnumbered" id="an-analogue-sensor">An analogue sensor</h4>
<p>An analogue sensor for measuring light intensity is shown in <a href="#/fig-wk7-analogue-sensor" class="quarto-xref">Figure&nbsp;1</a> along with a calibration graph that would be typically supplied in the data sheet for such a sensor.</p>

<img data-src="pictures/photo_sensor.png" alt="photograph of a light sensor and its calibration data." class="r-stretch quarto-figure-center" id="fig-wk7-analogue-sensor"><p class="caption">
Figure&nbsp;1: A photograph of a light sensor and its calibration data
</p></section>
<section class="slide level2">

<h3 id="sampling-and-quantization">Sampling and quantization</h3>
<p>Since microcontrollers can only handle 0s and 1s (digital signals) we need a way of converting analogue signals to digital signals. This is done using an <strong>analogue-to-digital</strong> converter or ADC.</p>
<div class="fragment">
<p>An ADC converts a <strong>continuous-time</strong> and <strong>continuous-amplitude</strong> analogue signal to a <strong>discrete-time and discrete-amplitude</strong> digital signal through the process called <strong>sampling and quantization</strong> illustrated in <a href="#/fig-wk6-sampling" class="quarto-xref">Figure&nbsp;2</a>.</p>
</div>
</section>
<section class="slide level2">

<h4 class="unnumbered" id="sampling-and-quantization-of-an-analogue-signal">Sampling and quantization of an analogue signal</h4>

<img data-src="pictures/Sampling.png" alt="Sampling and quantization of an analogue signal." class="r-stretch quarto-figure-center" id="fig-wk6-sampling"><p class="caption">
Figure&nbsp;2: Sampling and quantization of an analogue signal
</p></section>
<section class="slide level2">

<h3 id="adc-principles">ADC Principles</h3>
<p>An analogue signal is continuous in time and amplitude and to convert it to a digital signal it is necessary to <strong>periodically sample the analogue signal</strong>. The rate at which the signal is sampled is referred to as the <strong>sampling rate</strong>.</p>
<div class="fragment">
<p>Each time the signal is sampled the analogue value must be represented in one of several discrete <em>bins</em> (digital values). The number of discrete bins available is called the <strong>resolution</strong>.</p>
</div>
<div class="fragment">
<p>Both the sampling rate and the conversion resolution need to be sufficiently high to create an accurate digital reconstruction of the analogue signal.</p>
</div>
</section>
<section class="slide level2">

<h3 id="adc-sampling-rate">ADC Sampling Rate</h3>
<p>The Nyquist–Shannon sampling theorem implies that to get an accurate reproduction of the original signal, the sampling rate must be higher than twice the highest frequency of the signal. Lower than this and the reproduced signal will be distorted, and data lost.</p>
<aside class="notes">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This will be covered in more detail in EG-247 Digital Signal Processing in year 2</p>
</div>
</div>
</div>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section class="slide level2">

<h4 class="unnumbered" id="example">Example</h4>
<p>Consider the sine wave governed by the equation <span class="math inline">\(x(t) = sin(t)\)</span>. The period is <span class="math inline">\(2\pi\)</span> (approx. 6.3 seconds) so the frequency is 0.16 Hz (<a href="#/fig-wk6-sinewave" class="quarto-xref">Figure&nbsp;3</a>).</p>

<img data-src="pictures/sinewave.png" alt="Analogue signal x(t) = sin(t) - a sine wave." class="r-stretch quarto-figure-center" id="fig-wk6-sinewave"><p class="caption">
Figure&nbsp;3: Analogue signal <span class="math inline">\(x(t) = \sin(t)\)</span> - a sine wave.
</p></section>
<section class="slide level2">

<h5 id="sampled-sine-wave">Sampled sine wave</h5>
<p>If we sample this at 0.5 Hz (once every 2 seconds), which is over 3 times the original frequency, we get the orange trace <a href="#/fig-wk6-sampled-wave" class="quarto-xref">Figure&nbsp;4</a>. From this it would be enough to accurately recreate the blue trace.</p>

<img data-src="pictures/sampled_wave.png" alt="Sine wave x(t) = sin(t) sampled at 0.5 Hz." class="r-stretch quarto-figure-center" id="fig-wk6-sampled-wave"><p class="caption">
Figure&nbsp;4: Sine wave <span class="math inline">\(x(t) = \sin(t)\)</span> sampled at 0.5 Hz.
</p></section>
<section class="slide level2">

<h3 id="adc-resolution">ADC Resolution</h3>
<p>As well as the sampling rate, the resolution of the converter is crucial to getting an accurate representation of the input signal. The resolution indicates the number of discrete values that can be used over the total range of analogue values.</p>
</section>
<section class="slide level2">

<h4 id="a-2-bit-adc">A 2-bit ADC</h4>
<p>As an example a 2-bit ADC has <span class="math inline">\(2^2 = 4\)</span> quantization levels (<a href="#/fig-wk6-2bit" class="quarto-xref">Figure&nbsp;5</a>).</p>

<img data-src="pictures/2bitadc.png" alt="Illustration of the resolution of a 2 bit ADC." class="r-stretch quarto-figure-center" id="fig-wk6-2bit"><p class="caption">
Figure&nbsp;5: Illustration of the resolution of a 2 bit ADC
</p></section>
<section class="slide level2">

<h4 id="a-3-bit-adc-has-23-8-quantization-levels-fig-wk6-3bit.">A 3-bit ADC has <span class="math inline">\(2^3 = 8\)</span> quantization levels (<a href="#/fig-wk6-3bit" class="quarto-xref">Figure&nbsp;6</a>).</h4>

<img data-src="pictures/3bitadc.png" alt="Illustration of the resolution of a 3 bit ADC." class="r-stretch quarto-figure-center" id="fig-wk6-3bit"><p class="caption">
Figure&nbsp;6: Illustration of the resolution of a 3 bit ADC
</p></section>
<section class="slide level2 scrollable">

<h4 id="resolution-of-a-3-bit-adc">Resolution of a 3-bit ADC</h4>
<p>To calculate the resolution of an ADC we use <a href="#/eq-adc-res" class="quarto-xref">Equation&nbsp;1</a><sup>1</sup>.</p>
<p><span id="eq-adc-res"><span class="math display">\[
\mathrm{Digital\ Output} = \left\lfloor\frac{\left(2^N-1\right)\times\mathrm{Analogue\ Input\ Voltage}}{\mathrm{Reference\ Voltage}}\right\rfloor
\qquad(1)\]</span></span></p>
<aside><ol class="aside-footnotes"><li id="fn1"><p>Note the symbols <span class="math inline">\(\lfloor \ldots \rfloor\)</span> are called <em>floor</em>. They round a decimal number to the next lowest integer value. That is the decimal part is simply eliminated. Thus quantization is always going to choose the bin that is the closest to the truncated part of the decimal number.</p></li></ol></aside></section>
<section class="slide level2">

<p>The graph in <a href="#/fig-wk6-resolution" class="quarto-xref">Figure&nbsp;7</a> shows the values (<em>bins</em>) that are available for a three bit ADC.</p>

<img data-src="pictures/3bitresolution.png" alt="The resolution of a 3 bit ADC." class="r-stretch quarto-figure-center" id="fig-wk6-resolution"><p class="caption">
Figure&nbsp;7: The resolution of a 3 bit ADC
</p></section>
<section class="slide level2">

<section id="examples" class="unnumbered center">
<h3 class="unnumbered">Examples</h3>
</section>
</section>
<section class="slide level2">

<h4 class="unnumbered" id="example-1">Example 1</h4>
<p>Let’s say that we have a <strong>10-bit ADC</strong> and the reference voltage is <strong>5V</strong>.</p>
<div class="fragment">
<p>If our input is <strong>2.2V</strong> the the digital output will be:</p>
<p><span class="math display">\[\begin{align}
\mathrm{Digital\ Ouput} &amp;= \left\lfloor \frac{1023 \times 2.2}{5}\right\rfloor \\
&amp;= \lfloor 450.12 \rfloor = 450_{10}\\
&amp;= 10\ 1100\ 0010_2
\end{align}\]</span></p>
</div>
<aside class="notes">
<p>Notice in the first example when the resolution is 10-bit the answer consists of 10 bits not 12 or 16.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section class="slide level2">

<h4 class="unnumbered" id="example-2">Example 2</h4>
<p>Let’s say that we have a <strong>6-bit ADC</strong> and the reference voltage is <strong>3.3</strong>.</p>
<div class="fragment">
<p>If our input is <strong>1V</strong> the the digital output will be:</p>
<p><span class="math display">\[\begin{align}
\mathrm{Digital\ Ouput} &amp;= \left\lfloor \frac{63 \times 1}{3.3}\right\rfloor \\
&amp;= \lfloor 19.09 \rfloor = 19_{10}\\
&amp;= 01\ 0011_2
\end{align}\]</span></p>
</div>
</section>
<section class="slide level2">

<section id="illustrating-the-sampling-theorem" class="center">
<h4>Illustrating the sampling theorem</h4>
</section>
</section>
<section class="slide level2">

<h5 id="violation-of-the-sampling-theorem">Violation of the sampling theorem</h5>
<aside class="notes">
<p>Consider the signal with frequency <span class="math inline">\(F_c = 1\)</span>Hz, sampling frequency of <span class="math inline">\(F_s = 1\)</span>Hz, and resolution = 3 bits. The sampled signal is illustrated in <a href="#/fig-wk6-violation" class="quarto-xref">Figure&nbsp;8</a>. The Nyquist-Shannon sampling theorem has clearly been violated and the original signal cannot be reconstructed from the sampled signal.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>

<img data-src="pictures/violation.png" alt="Illustration of the violation of the sampling thereom - signal cannot be reconstructed from sampled signal." class="r-stretch quarto-figure-center" id="fig-wk6-violation"><p class="caption">
Figure&nbsp;8: Violation of the sampling thereom: signal cannot be reconstructed from sampled signal
</p></section>
<section class="slide level2">

<h5 id="sampling-at-twice-the-signal-frequency">Sampling at twice the signal frequency</h5>
<aside class="notes">
<p>Consider the signal with frequency <span class="math inline">\(F_c = 1\)</span>Hz, sampling frequency of <span class="math inline">\(F_s = 2\)</span>Hz (the so-called Nyquist frequency), and resolution = 3 bits. The sampled signal is illustrated in <a href="#/fig-wk6-nyquist" class="quarto-xref">Figure&nbsp;9</a>. The reconstructed signal is on the border of acceptable. In practice, we need to sample at a higher frequency than <span class="math inline">\(F_s = 2F_c\)</span>.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>

<img data-src="pictures/nyquist.png" alt="Illustration of a signal sampled at the Nyquist frequency. Signal is just about reconstructable from the sampled data." class="r-stretch quarto-figure-center" id="fig-wk6-nyquist"><p class="caption">
Figure&nbsp;9: Signal sampled at the Nyquist frequency and 3-bit resolution. Signal is just about reconstructable from the sampled data.
</p></section>
<section class="slide level2">

<section id="illustrating-sampling-and-quantization" class="center">
<h4>Illustrating sampling and quantization</h4>
</section>
<h5 id="sampling-at-five-times-the-signal-frequency">Sampling at five times the signal frequency</h5>
<aside class="notes">
<p>Consider the signal with frequency <span class="math inline">\(F_c = 1\)</span>Hz, sampling frequency of <span class="math inline">\(F_s = 5\)</span>Hz, and resolution = 3 bits. The sampled signal is illustrated in <a href="#/fig-wk6-5fs" class="quarto-xref">Figure&nbsp;10</a>. The reconstructed signal (in the bottom trace) is starting to look like a sine wave.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>

<img data-src="pictures/5fs.png" alt="Illustration of a signal sampled at the 5 x Nyquist frequency." class="r-stretch quarto-figure-center" id="fig-wk6-5fs"><p class="caption">
Figure&nbsp;10: Signal sampled at the <span class="math inline">\(Fs = 5 F_c\)</span> and 3-bit resolution.
</p></section>
<section class="slide level2">

<h5 id="sampling-at-ten-times-the-signal-frequency">Sampling at ten times the signal frequency</h5>
<aside class="notes">
<p>Consider the signal with frequency <span class="math inline">\(F_c = 1\)</span>Hz, sampling frequency of <span class="math inline">\(F_s = 10\)</span>Hz, and resolution = 3 bits. The sampled signal is illustrated in <a href="#/fig-wk6-10fs" class="quarto-xref">Figure&nbsp;11</a>. The reconstructed signal now starting to look like a sine wave. In general, the faster the sampling frequency compared to the frequency of the analogue signal, the better the approximation.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>

<img data-src="pictures/10fs.png" alt="Illustration of a signal sampled at the 5 x Nyquist frequency." class="r-stretch quarto-figure-center" id="fig-wk6-10fs"><p class="caption">
Figure&nbsp;11: Signal sampled at the <span class="math inline">\(Fs = 10 F_c\)</span> and 3-bit resolution.
</p></section>
<section id="sec-wk6-sect2" class="slide level2">
<h2>ADC Architecture</h2>

<img data-src="pictures/adc_arch.png" alt="The architecture of the ADC system in the Atmel ATmega328 Processor." class="r-stretch quarto-figure-center" id="fig-wk6-atmel-adc"><p class="caption">
Figure&nbsp;12: The architecture of the ADC system in the Atmel ATmega328 Processor (source <a href="https://ww1.microchip.com/downloads/en/DeviceDoc/ATmega48A-PA-88A-PA-168A-PA-328-P-DS-DS40002061A.pdf">ATmega48A-PA-88A-PA-168A-PA-328-P-DS-DS40002061B</a>, Page 247)
</p></section>
<section class="slide level2 scrollable">

<h3 id="adc-components">ADC Components</h3>
<p>The architecture of the Atmel ATmega328 is shown in <a href="#/fig-wk6-atmel-adc" class="quarto-xref">Figure&nbsp;12</a>. It contains the following major components:</p>
<ul>
<li class="fragment">Multiplexer<sup>1</sup></li>
<li class="fragment">Voltage Reference</li>
<li class="fragment">Digital to Analogue Converter (DAC)</li>
<li class="fragment">Sample and Hold Circuit</li>
<li class="fragment">Control and Result Registers</li>
</ul>
<aside class="notes">
<p>The most important components are described in more detail in the following sections.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
<aside><ol class="aside-footnotes"><li id="fn2"><p>The multiplexer allows multiple inputs to share one set of ADC hardware.</p></li></ol></aside></section>
<section class="slide level2">

<h3 id="architectures">Architectures</h3>
<p>There are several achitectures for ADCs summarized as:</p>
<ul>
<li class="fragment">Sigma-Delta (<span class="math inline">\(\Sigma-\Delta\)</span>)</li>
<li class="fragment">Successive Approximation Register (SAR)</li>
<li class="fragment">Pipelined</li>
<li class="fragment">Flash</li>
</ul>
<div class="fragment">
<p>Each has their own advantages and disadvantages in terms of price, conversion speed, noise and complexity as summarized in <a href="#/fig-wk6-adc_archs" class="quarto-xref">Figure&nbsp;13</a>.</p>
</div>
</section>
<section class="slide level2">

<h4 id="adc-architecture-vs-resolution-and-sample-rate">ADC Architecture vs Resolution and Sample Rate</h4>

<img data-src="pictures/adc_archs.png" alt="ADC Architecture vs Resolution and Sample Rate." class="r-stretch quarto-figure-center" id="fig-wk6-adc_archs"><p class="caption">
Figure&nbsp;13: ADC Architecture vs Resolution and Sample Rate (Source <a href="https://scholarworks.calstate.edu/downloads/v979v314q">calstate.edu</a>)
</p><div class="fragment">
<p>Most general-purpose microcontrollers contain SAR-based architecture ADCs.</p>
</div>
</section>
<section class="slide level2">

<h3 id="sar-based-adc-architecture">SAR based ADC Architecture</h3>
<aside class="notes">
<p>Successive-approximation-register (SAR) ADCs are the most common architecture for medium-to-high-resolution applications with sample rates under 5 megasamples per second.</p>
<p>The SAR converter is essentially a binary search algorithm which compares the input to the ADC with the output from a digital to analogue converter (DAC) until the input matches the DAC output and the device is able to output the corresponding binary value.</p>
<p>While the internal circuitry of the ADC may be running at several megahertz, the ADC sample rate is a fraction of that number due to the multiple step successive-approximation algorithm needed to convert the measured input to a binary number.</p>
<p>The SAR converter is at the heart of the ATmega328 microcontroller and is highlighted in <a href="#/fig-wk6-sar" class="quarto-xref">Figure&nbsp;14</a>.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>

<img data-src="pictures/sar_converter.png" alt="Schematic diagram of the Atmel ATMega328 ADC system with the SAR highlighted." class="r-stretch quarto-figure-center" id="fig-wk6-sar"><p class="caption">
Figure&nbsp;14: Schematic diagram of the Atmel ATMega328 ADC system with the SAR highlighted.
</p></section>
<section class="slide level2 scrollable">

<h4 id="sar-based-adc-operation">SAR based ADC Operation</h4>
<aside class="notes">
<p>Consider the schematic diagram shown in <a href="#/fig-wk6-sar-converter" class="quarto-xref">Figure&nbsp;15</a>.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
<div id="fig-wk6-sar-converter" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig">
<div aria-describedby="fig-wk6-sar-converter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img data-src="pictures/sar.png">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wk6-sar-converter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15: Schematic diagram of the hardware used to achieve SAR conversion (image source: Analog Devices<sup>1</sup>).
</figcaption>
</figure>
</div>
<aside><ol class="aside-footnotes"><li id="fn3"><p><a href="https://www.analog.com/en/technical-articles/successive-approximation-registers-sar-and-flash-adcs.html">Understanding SAR ADCs: Their Architecture and Comparison with Other ADCs</a>, Analog Devices.</p></li></ol></aside></section>
<section class="slide level2 scrollable">

<h4 id="sar-operation">SAR operation</h4>
<ul>
<li class="fragment">The analogue input signal is held by a track/hold circuit and fed as <span class="math inline">\(V_\mathrm{IN}\)</span> into a comparator.</li>
<li class="fragment">To implement the binary search algorithm, the <span class="math inline">\(N\)</span>-bit register is first set to mid-scale (that is the MSB is set to 1 and all other bits set to 0) so that the voltage at <span class="math inline">\(V_\mathrm{DAC} = V_\mathrm{REF}/2\)</span>.</li>
<li class="fragment">A comparison is then performed to determine if <span class="math inline">\(V_\mathrm{IN} \le  V_\mathrm{DAC}\)</span>.
<ul>
<li class="fragment">If <span class="math inline">\(V_\mathrm{IN} &gt;  V_\mathrm{DAC}\)</span>, the comparator output will be logic high (or 1), and the MSB of the <span class="math inline">\(N\)</span>-bit register remains at 1.</li>
<li class="fragment">If <span class="math inline">\(V_\mathrm{IN} &lt;  V_\mathrm{DAC}\)</span>, the comparator output is a logic low (0) and the MSB of the <span class="math inline">\(N\)</span>-register is cleared to logic 0.</li>
</ul></li>
<li class="fragment">The SAR control logic then moves to the next bit along<sup>1</sup>, forces that bit high, and repeats the comparison. The sequence continues all the way down to the LSB (bit 0).</li>
<li class="fragment">Once the input has been compared with the full <span class="math inline">\(N\)</span>-bit register the conversion is complete and the <span class="math inline">\(N\)</span>-bit digital word is sent to the ADC output register.</li>
</ul>
<aside><ol class="aside-footnotes"><li id="fn4"><p>The “next bit along” will be the MSB-<span class="math inline">\(1^\mathrm{th}\)</span> bit. That is, for a 12-bit ADC, MSB is bit 11, and the next bit along will be bit 10. If the previous comparison produced a 1, the binary value we are testing is now <span class="math inline">\(2^{11} + 2^{10} = 2048 + 1024 = 3072\)</span>. If the comparison at the previous step was 0, the binary value we are testing is now <span class="math inline">\(2^{10} = 1024\)</span>. The corresponding values of <span class="math inline">\(V_\mathrm{DAC}\)</span> will now be either <span class="math inline">\(3072/4096 V_\mathrm{REF} = 0.75 V_\mathrm{REF}\)</span> or <span class="math inline">\(1024/4096 V_\mathrm{REF} = 0.25 V_\mathrm{REF}\)</span>. This process continues until all bits have been considered.</p></li></ol></aside></section>
<section class="slide level2 scrollable">

<h4 id="bit-sar-based-adc-example">4-bit SAR based ADC Example</h4>

<img data-src="pictures/sar_operation.png" alt="Example of the successive approximation method in action." class="r-stretch quarto-figure-center" id="fig-wk6-sar-example"><p class="caption">
Figure&nbsp;16: Example of the successive approximation method in action: a 4 bit ADC converting a signal for which <span class="math inline">\(V_\mathrm{IN}\)</span> is in “bin” 5.
</p><aside class="notes">
<p>Consider <a href="#/fig-wk6-sar-example" class="quarto-xref">Figure&nbsp;16</a>:</p>
<ol type="1">
<li>Bit 3 is set high (compare signal is <span class="math inline">\(1000_2\)</span>)
<ul>
<li><span class="math inline">\(V_\mathrm{IN} &lt; V_\mathrm{DAC}\)</span> so the comparator output is low (0).</li>
</ul></li>
<li>Bit 3 is set low and bit 2 is set high (compare signal is now <span class="math inline">\(0100_2\)</span>).
<ul>
<li><span class="math inline">\(V_\mathrm{IN} &gt; V_\mathrm{DAC}\)</span> so the comparator output is high (1).</li>
</ul></li>
<li>Bit 2 remains high and now Bit 1 is set high too (compare signal is <span class="math inline">\(0110_2\)</span>).
<ul>
<li><span class="math inline">\(V_\mathrm{IN} &lt; V_\mathrm{DAC}\)</span> so the comparator output is low (0).</li>
</ul></li>
<li>Bit 1 is set low and bit 0 is set high (compare signal is <span class="math inline">\(0101_2\)</span>)
<ul>
<li><span class="math inline">\(V_\mathrm{IN} &gt; V_\mathrm{DAC}\)</span> so the comparator output is high (1).</li>
</ul></li>
</ol>
<p>The final output of the conversion is <span class="math inline">\(0101_2 = 5/16 V_\mathrm{REF} = 0.3125 V_\mathrm{REF}\)</span>.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section id="sec-wk6-sect3" class="slide level2 center" data-background-image="pictures/week6_arduino_nano_wallpaper.jpg">
<h2>The Atmel ATmega328 Analog-digital-converter</h2>
</section>
<aside class="notes">
<p><img data-src="pictures/week6_arduino_nano_wallpaper.jpg" alt="Decorative section background - showing an Arduino nano microcontroller and an LED light strip."></p>
<p>Image source: <a href="https://www.flickr.com/photos/netlcom/36486445205/">This Photo</a> by Unknown Author is licensed under <a href="https://creativecommons.org/licenses/by-nc/3.0/">CC BY-NC</a></p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
<section class="slide level2">

<h3 id="the-atmel-atmega328-adc">The Atmel ATMega328 ADC</h3>
<p>The Atmel ATMega328 features a <strong>10-bit successive approximation ADC</strong>.</p>
<p>The ADC is connected to an 8-channel <strong>Analog Multiplexer</strong> which allows eight single-ended voltage inputs (referenced to GND) constructed from the pins of Port C.</p>
</section>
<section class="slide level2 scrollable">

<h4 id="technical-specifications">Technical specifications</h4>
<p>The ADC provides:</p>
<ul>
<li class="fragment">10-bit Resolution</li>
<li class="fragment">13 - 260μs Conversion Time</li>
<li class="fragment">Up to 76.9kSPS<sup>1</sup> (Up to 15kSPS at Maximum Resolution)</li>
<li class="fragment">9 Multiplexed Single Ended Input Channels</li>
</ul>
<aside><ol class="aside-footnotes"><li id="fn5"><p>SPS = Samples per second.</p></li></ol></aside></section>
<section class="slide level2">

<h4 id="hardware-registers-used">Hardware registers used</h4>
<ul>
<li class="fragment"><code>ADMUX</code> - ADC Multiplexer Selection Register.</li>
<li class="fragment"><code>ADCSRA</code> - ADC Status and Control Register A.</li>
<li class="fragment"><code>ADCSRB</code> - ADC Status and Control Register B.</li>
<li class="fragment"><code>ADCL</code> and <code>ADCH</code> - The ADC Output Registers.</li>
<li class="fragment"><code>DIDR0</code> - Digital Input Disable Register 0.</li>
</ul>
<div class="fragment">
<p>These registers are described in the following sections.</p>
</div>
</section>
<section class="slide level2">

<h5 id="admux-adc-multiplexer-selection">ADMUX – ADC Multiplexer Selection</h5>
<p>The <code>ADMUX</code> is an 8-bit register arranged as shown in <a href="#/fig-wk6-admux" class="quarto-xref">Figure&nbsp;17</a>.</p>

<img data-src="pictures/admux.png" alt="The ADMUX Register." class="r-stretch quarto-figure-center" id="fig-wk6-admux"><p class="caption">
Figure&nbsp;17: The ACD Multplexer Selection Register <code>ADMUX</code> (Source: Atmel Documentation).
</p></section>
<section class="slide level2 scrollable">

<h5 id="reference-selection-bits">Reference selection bits</h5>
<p><img data-src="pictures/admux-bits76.png" alt="The ADMUX Register with bits 7 and 6 highlighted."></p>
<p>Bits 7 and 6—<code>REFS1</code> and <code>REFS0</code>—select the reference voltage for the ADC<sup>1</sup>.</p>
<aside class="notes">
<p>The settings for the reference selection bits are tabulated in <a href="#/tbl-wk6-table1" class="quarto-xref">Table&nbsp;1</a>.</p>
<div id="tbl-wk6-table1" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-wk6-table1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: The settings for the reference selection bits of the <code>ADMUX</code> register.
</figcaption>
<div aria-describedby="tbl-wk6-table1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top">
<colgroup>
<col style="width: 18%">
<col style="width: 15%">
<col style="width: 65%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">REFS1</th>
<th style="text-align: left;">REFS0</th>
<th style="text-align: left;">Voltage Reference Selection</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">AREF, Internal <span class="math inline">\(V_\mathrm{REF}\)</span> turned off.</td>
</tr>
<tr class="even">
<td style="text-align: left;">0</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">AVCC with external capacitor on <code>AREF</code>.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">Reserved</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">Internal 1.1V reference with external capacitor at <code>AREF</code> pin.</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
<aside><ol class="aside-footnotes"><li id="fn6"><p>The internal voltage reference options may not be used if an external reference voltage is being applied to the <em>AREF</em> pin of the microcontroller chip.</p></li></ol></aside></section>
<section class="slide level2">

<h5 id="bit-5-adlar-adc-left-adjust-result">Bit 5 – <code>ADLAR</code>: ADC Left Adjust Result</h5>

<img data-src="pictures/admux-bit5.png" alt="The ADMUX Register with bit5 highlighted." class="r-stretch"><p><code>ADLAR</code> bit (bit 5) affects the presentation of the ADC conversion result in the <strong>ADC Data Register</strong>.</p>
<p>We write 1 to <code>ADLAR</code> to <em>left adjust</em> the result.</p>
<p>Otherwise, the result is <em>right adjusted</em>.</p>
<aside class="notes">
<p><em>We will revisit this in a couple of slides when we discuss the results registers</em>.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section class="slide level2">

<h5 id="bits-30-mux30-analog-channel-selection-bits">Bits 3:0 – <code>MUX[3:0]</code>: Analog Channel Selection Bits</h5>

<img data-src="pictures/admux-mux.png" alt="The ADMUX Register with bit5 highlighted." class="r-stretch"><p>The value of these bits selects which analogue inputs are connected to the ADC (see <a href="#/fig-wk6-admux-mux" class="quarto-xref">Figure&nbsp;18</a> and <a href="#/tbl-wk6-table2" class="quarto-xref">Table&nbsp;2</a>).</p>
</section>
<section class="slide level2">


<img data-src="pictures/mux_pins.png" alt="The pins on the Atmel ATmega328 that may be multiplexed to act as ADC inputs." class="r-stretch quarto-figure-center" id="fig-wk6-admux-mux"><p class="caption">
Figure&nbsp;18: The pins on the Atmel ATmega328 that may be multiplexed to act as ADC inputs
</p></section>
<section class="slide level2">

<div id="tbl-wk6-table2" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-wk6-table2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: ADC multiplexer bit settings for the ADMUX register
</figcaption>
<div aria-describedby="tbl-wk6-table2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: left;">MUX3:0</th>
<th style="text-align: left;">Input Selected</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(0000\)</span></td>
<td style="text-align: left;">ADC0</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(0001\)</span></td>
<td style="text-align: left;">ADC1</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(0010\)</span></td>
<td style="text-align: left;">ADC2</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(0011\)</span></td>
<td style="text-align: left;">ADC3</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(0100\)</span></td>
<td style="text-align: left;">ADC4</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(0101\)</span></td>
<td style="text-align: left;">ADC5</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(0110\)</span></td>
<td style="text-align: left;">ADC6 - Not used on the Arduino nano board</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(0111\)</span></td>
<td style="text-align: left;">ADC7 - Not used on the Arduino nano board</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(1000\)</span></td>
<td style="text-align: left;">ADC8 - Used for internal temperature sensor.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(1001\)</span></td>
<td style="text-align: left;">Reserved</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(1010\)</span></td>
<td style="text-align: left;">Reserved</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(1011\)</span></td>
<td style="text-align: left;">Reserved</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(1100\)</span></td>
<td style="text-align: left;">Reserved</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(1101\)</span></td>
<td style="text-align: left;">Reserved</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(1110\)</span></td>
<td style="text-align: left;">1.1V (<span class="math inline">\(V_\mathrm{BG}\)</span>)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(1111\)</span></td>
<td style="text-align: left;">GND</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section class="slide level2">

<h5 id="adcsra---adc-control-and-status-register-a"><code>ADCSRA</code> - ADC Control and Status Register A</h5>
<h6 id="bit-7---aden-adc-enable">Bit 7 - <code>ADEN</code>: ADC Enable</h6>

<img data-src="pictures/adcsra7.png" alt="ADCSRCA with bit 7 highlighted." class="r-stretch"><p>Writing 1 to bit 7 of the <code>ADCSRA</code> register enables the ADC. Writing 0 to this bit turns the ADC off.</p>
</section>
<section class="slide level2">

<h6 id="bit-6---adsc-adc-start-conversion">Bit 6 - <code>ADSC</code>: ADC Start Conversion</h6>

<img data-src="pictures/adcsra6.png" alt="ADCSRCA with bit 6 highlighted." class="r-stretch"><ul>
<li class="fragment">In <em>Single Conversion Mode</em>, writing 1 to bit 6 of the <code>ADCSRA</code> register starts the conversion.</li>
<li class="fragment">In <em>Free Running Mode</em>, writing 1 to this bit starts the first conversion.</li>
</ul>
</section>
<section class="slide level2 scrollable">

<h6 id="bit-5---adate-adc-start-conversion">Bit 5 - <code>ADATE</code>: ADC Start Conversion</h6>
<p><img data-src="pictures/adcsra5.png" alt="ADCSRCA with bit 5 highlighted."></p>
<p>When 1 is written to bit 5 of the <code>ADCSRA</code> register, the ADC will start a conversion on a positive edge of the selected trigger signal<sup>1</sup></p>
<aside><ol class="aside-footnotes"><li id="fn7"><p>This bit is used for clock-based ADC operation when you need a controlled and predictable sampling rate.</p></li></ol></aside></section>
<section class="slide level2">

<h6 id="bit-4---adif-adc-interrupt-flag">Bit 4 - <code>ADIF</code>: ADC Interrupt Flag</h6>

<img data-src="pictures/adcsra4.png" alt="ADCSRCA with bit 4 highlighted." class="r-stretch"><p>This bit is set when an ADC conversion completes, and the data registers are updated. The <em>ADC Conversion Complete Interrupt</em> is executed if the <code>ADIE</code> bit and the I-bit in the status register are set.</p>
</section>
<section class="slide level2">

<h6 id="bit-3---adie-adc-interrupt-enable">Bit 3 - <code>ADIE</code>: ADC Interrupt Enable</h6>

<img data-src="pictures/adcsra3.png" alt="ADCSRCA with bit 3 highlighted." class="r-stretch"><p>Writing 1 to bit30 of the <code>ADCSRA</code> register, when the I-bit in the status register is set, activates the <em>ADC Conversion Complete Interrupt</em></p>
</section>
<section class="slide level2">

<h5 id="bits-2-0---adps20-adc-interrupt-enable">Bits 2-0 - <code>ADPS[2:0]</code>: ADC Interrupt Enable</h5>

<img data-src="pictures/adcsra2-0.png" alt="ADCSRCA with bit2 2-0 highlighted." class="r-stretch"><p>Bits 2-0 of <code>ADCSRA</code> determine the division factor between the system clock frequency and the input clock to the ADC. That is they set the sample rate for free-running mode. The prescaler settings are tabulated in <a href="#/tbl-wk7-table3" class="quarto-xref">Table&nbsp;3</a>.</p>
</section>
<section class="slide level2">

<div id="tbl-wk7-table3" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-wk7-table3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Clock Division Factor selected by Prescaler Select Bits 2-0
</figcaption>
<div aria-describedby="tbl-wk7-table3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top">
<thead>
<tr class="header">
<th><code>ADPS2</code></th>
<th><code>ADPS1</code></th>
<th><code>ADPS0</code></th>
<th style="text-align: right;">Division Factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>1</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>0</td>
<td>1</td>
<td>0</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>0</td>
<td>1</td>
<td>1</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>0</td>
<td style="text-align: right;">16</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>1</td>
<td style="text-align: right;">32</td>
</tr>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>0</td>
<td style="text-align: right;">64</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>1</td>
<td style="text-align: right;">128</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section class="slide level2">

<h5 id="adcsrb---adc-control-and-status-register-b">ADCSRB - ADC Control and Status Register B</h5>
<h6 id="bit-6---acme-analogue-comparator-multiplexer-enable">Bit 6 - <code>ACME</code>: Analogue comparator multiplexer enable</h6>

<img data-src="pictures/adcsrb6.png" alt="ADCSRB with bit 6 highlighted." class="r-stretch"><p>When logic 1 is written to bit 6 of <code>ADCSRB</code> the ADC is switched off, the ADC multiplexer selects the negative input to the <em>Analog Comparator</em>. When 0 is written to this bit, <code>AIN1</code> is applied to the negative input of the Analog Comparator.</p>
<aside class="notes">
<p>Note: The Analog Comparator compares the input values on the positive pin <code>AIN0</code> and negative pin <code>AIN1</code>. When the voltage on the positive pin AIN0 is higher than the voltage on the negative pin <code>AIN1</code>, the Analog Comparator output, <code>ACO</code>, is set.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section class="slide level2">

<h6 id="bits-20---adt20-adc-autotrigger-source">Bits 2:0 - <code>ADT[2:0]</code>: ADC Autotrigger source</h6>

<img data-src="pictures/adcsrb6.png" alt="ADCSRB with bit 6 highlighted." class="r-stretch"><p>If logic 1 is written to the <code>ADATE</code> bit in the <code>ADCSRA</code> register, the value of the <code>ADTS</code> bits selects which source will trigger an ADC conversion. The trigger source settings are tabulated in <a href="#/tbl-wk7-table4" class="quarto-xref">Table&nbsp;4</a>.</p>
</section>
<section class="slide level2">

<div id="tbl-wk7-table4" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-wk7-table4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: ADC Trigger Source.
</figcaption>
<div aria-describedby="tbl-wk7-table4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top">
<thead>
<tr class="header">
<th><code>ADTS2</code></th>
<th><code>ADTS1</code></th>
<th><code>ADTS0</code></th>
<th style="text-align: left;">Trigger Source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0</td>
<td style="text-align: left;">Free Running Mode</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>1</td>
<td style="text-align: left;">Analogue Comparitor</td>
</tr>
<tr class="odd">
<td>0</td>
<td>1</td>
<td>0</td>
<td style="text-align: left;">External Interrupt Request 0</td>
</tr>
<tr class="even">
<td>0</td>
<td>1</td>
<td>1</td>
<td style="text-align: left;">Timer/Counter 0 Compare Match A</td>
</tr>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>0</td>
<td style="text-align: left;">Timer/Counter 0 Overflow</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>1</td>
<td style="text-align: left;">Timer/Counter 0 Compare Match B</td>
</tr>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>0</td>
<td style="text-align: left;">Timer/Counter 1 Overflow</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>1</td>
<td style="text-align: left;">Timer/Counter 1 Capture Event</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section class="slide level2 scrollable">

<h5 id="adcl-and-adch---the-adc-data-registers">ADCL and ADCH - The ADC Data Registers</h5>
<p>The ADC Data Registers are illustrated in <a href="#/fig-wk6-adc-data" class="quarto-xref">Figure&nbsp;19</a>.</p>
<div id="fig-wk6-adc-data" class="quarto-float quarto-figure quarto-figure-center" alt="The ADC Data Registers.">
<figure class="quarto-float quarto-float-fig">
<div aria-describedby="fig-wk6-adc-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img data-src="pictures/adc_results.png" alt="The ADC Data Registers.">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wk6-adc-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19: The ADC Data Registers <code>ADCH</code> and <code>ADCL</code> when (a) ADLAR = 0 and (b) when ADLAR = 1.
</figcaption>
</figure>
</div>
<p>When an ADC conversion is complete, the result is put in these two registers<sup>1</sup>.</p>
<p>When <code>ADCL</code> is read, the ADC Data Register is not updated until <code>ADCH</code> is read.</p>
<p>If the result is left adjusted and no more than 8-bit precision is required, it is sufficient to read <code>ADCH</code>. Otherwise, <code>ADCL</code> must be read first, then <code>ADCH</code>.</p>
<aside><ol class="aside-footnotes"><li id="fn8"><p>Recall that the ADC has a precision of up to 10 bits so two data registers are required. Register <code>ADCL</code> contains the least significant 8 bits, bits [0-7] and <code>ACDH</code> contains the most significant bits bit 8 and bit 9.</p></li></ol></aside></section>
<section class="slide level2">

<h5 id="didr0---digital-input-disable-register-0"><code>DIDR0</code> - Digital Input Disable Register 0</h5>
<h6 id="bits-50---adc5dadc0d-adc50-digital-input-disable">Bits 5:0 - ADC5D…ADC0D: ADC5…0 Digital Input Disable</h6>

<img data-src="pictures/didr0.png" alt="Register DIDR0 with bits 0-5 highlighted." class="r-stretch"><p>When logic 1 is written to one of these bits, the digital input buffer on the corresponding ADC pin is disabled. (i.e.&nbsp;the corresponding PIN register bit will always read zero).</p>
<p>When an analog signal is applied to the ADC5…0 pin and the digital input from this pin is not needed, logic 1 should be written to this bit to reduce power consumption in the digital input buffer.</p>
</section>
<section class="slide level2 scrollable">

<h4 id="setting-up-the-adc">Setting up the ADC</h4>
<aside class="notes">
<p>The following steps are illustrated in flow-chart form in <a href="#/fig-wk6-flc1" class="quarto-xref">Figure&nbsp;20</a>.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>

<img data-src="pictures/flc1.png" style="width:30.0%" alt="A flow chart of the ADC initialization steps." class="r-stretch quarto-figure-center" id="fig-wk6-flc1"><p class="caption">
Figure&nbsp;20: A flow chart of the ADC initialization steps
</p><aside class="notes">
<p>In words, the operations to be completed are:</p>
<ol type="1">
<li><strong>Define</strong> convenient <strong>names</strong> for the required registers.</li>
<li>Set the <strong>data direction</strong> of the relevant pins to input (<code>DDRxn</code>)</li>
<li>Set the corresponding pin in the <strong>input disable register</strong> to 1 to disable the input buffer (<code>DIDR0</code>)</li>
<li>Select the <strong>reference voltage</strong>, <strong>result alignment</strong> and <strong>input channel</strong> (<code>ADMUX</code>)</li>
<li>Select the <strong>ADC prescaler value</strong> in the A control and status register (<code>ADCSRA</code>)</li>
<li>Write a <strong>1 to the <code>ADEN</code> bit</strong> of the A control and status register to enable the ADC (<code>ADCSRA</code>)</li>
</ol>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section class="slide level2 scrollable">

<aside class="notes">
<p>The <strong>main code</strong> is illustrated in the flowchart shown in <a href="#/fig-wk6-flc2" class="quarto-xref">Figure&nbsp;21</a>.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>

<img data-src="pictures/flc2.png" style="width:25.0%" alt="A flow chart of the ADC operation loop." class="r-stretch quarto-figure-center" id="fig-wk6-flc2"><p class="caption">
Figure&nbsp;21: A flow chart of the ADC operation loop
</p><aside class="notes">
<p>In words, the operations to be completed are:</p>
<ol type="1">
<li>Within the infinite for loop, <strong>Write a 1 to the <code>ADSC</code> bit</strong> of the A control and status register each time you want to start a conversion (`ADCSRA``)</li>
<li>Monitor for the <strong><code>ADSC</code> bit going low</strong> (or the <code>ADIF</code> bit going high) of the A control and status register.</li>
<li>Read the converted value from the result registers (<code>ADCH</code> and <code>ADCL</code>).</li>
<li>Do something with the ADC result.</li>
</ol>
<p>We illustrate this in <a href="#/sec-wk6-sect4" class="quarto-xref">Section&nbsp;4</a>.</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section id="sec-wk6-sect4" class="slide level2 center" data-background-image="pictures/adc_board_wallpaper.png">
<h2>Analogue I/O Example program</h2>
</section>
<aside class="notes">
<p><img data-src="pictures/adc_board_wallpaper.png" alt="Decorative image showing a protopype ADC application for the Arduino nano."></p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
<section class="slide level2">

<h3 id="single-conversion-example">Single Conversion Example</h3>

<img data-src="pictures/adc_board.jpg" alt="The prototype board showing the finished Arduino nano application with ADC and digital outputs." class="r-stretch quarto-figure-center" id="fig-wk6-adc_board"><p class="caption">
Figure&nbsp;22: The prototype board showing the finished Arduino nano application with ADC and digital outputs.
</p></section>
<section class="slide level2">

<ul>
<li class="fragment">The centre tap of the blue potentiometer shown in <a href="#/fig-wk6-adc_board" class="quarto-xref">Figure&nbsp;22</a> is connected to the analogue input <code>A0</code> which represents Port C Bit 0 on the ATmega328 microcontroller.</li>
<li class="fragment">As the voltage at the input changes, the value is reflected on the 6 LEDs.</li>
<li class="fragment">What does the code for this look like without using the predefined Arduino function – <code>analogRead</code>?</li>
</ul>
</section>
<section class="slide level2">

<h3 id="example-code---aligning-port-names-to-the-io-memory-map">Example code - aligning port names to the I/O memory map</h3>
<p>We showed how we use the <code>#define</code> function to map our program variables to the I/O memory map shown in <a href=".\lectures/week05/#sec-wk5-align-to-io-mem-map">Example code - aligning port names to the I/O memory map</a>. We use the same technique to map the digital and analogue registers to programmer friendly names:</p>
</section>
<section class="slide level2">

<div class="sourceCode" id="cb1" data-code-line-numbers="|6-11|6|7|8|9|10|11"><pre class="sourceCode numberSource c number-lines code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href=""></a><span class="co">//I/O and ADC Register definitions taken from datasheet</span></span>
<span id="cb1-2"><a href=""></a><span class="pp">#define PORTB  </span><span class="op">(*(</span><span class="dt">volatile</span><span class="pp"> </span><span class="dt">uint8_t</span><span class="pp"> </span><span class="op">*)(</span><span class="bn">0x25</span><span class="op">))</span></span>
<span id="cb1-3"><a href=""></a><span class="pp">#define DDRB   </span><span class="op">(*(</span><span class="dt">volatile</span><span class="pp"> </span><span class="dt">uint8_t</span><span class="pp"> </span><span class="op">*)(</span><span class="bn">0x24</span><span class="op">))</span></span>
<span id="cb1-4"><a href=""></a><span class="pp">#define PINB   </span><span class="op">(*(</span><span class="dt">volatile</span><span class="pp"> </span><span class="dt">uint8_t</span><span class="pp"> </span><span class="op">*)(</span><span class="bn">0x23</span><span class="op">))</span></span>
<span id="cb1-5"><a href=""></a></span>
<span id="cb1-6"><a href=""></a><span class="pp">#define ADMUX  </span><span class="op">(*(</span><span class="dt">volatile</span><span class="pp"> </span><span class="dt">uint8_t</span><span class="pp"> </span><span class="op">*)(</span><span class="bn">0x7C</span><span class="op">))</span></span>
<span id="cb1-7"><a href=""></a><span class="pp">#define ADCSRA </span><span class="op">(*(</span><span class="dt">volatile</span><span class="pp"> </span><span class="dt">uint8_t</span><span class="pp"> </span><span class="op">*)(</span><span class="bn">0x7A</span><span class="op">))</span></span>
<span id="cb1-8"><a href=""></a><span class="pp">#define ADCRSB </span><span class="op">(*(</span><span class="dt">volatile</span><span class="pp"> </span><span class="dt">uint8_t</span><span class="pp"> </span><span class="op">*)(</span><span class="bn">0x7B</span><span class="op">))</span></span>
<span id="cb1-9"><a href=""></a><span class="pp">#define ADCH   </span><span class="op">(*(</span><span class="dt">volatile</span><span class="pp"> </span><span class="dt">uint8_t</span><span class="pp"> </span><span class="op">*)(</span><span class="bn">0x79</span><span class="op">))</span></span>
<span id="cb1-10"><a href=""></a><span class="pp">#define ADCL   </span><span class="op">(*(</span><span class="dt">volatile</span><span class="pp"> </span><span class="dt">uint8_t</span><span class="pp"> </span><span class="op">*)(</span><span class="bn">0x78</span><span class="op">))</span></span>
<span id="cb1-11"><a href=""></a><span class="pp">#define DIDR0  </span><span class="op">(*(</span><span class="dt">volatile</span><span class="pp"> </span><span class="dt">uint8_t</span><span class="pp"> </span><span class="op">*)(</span><span class="bn">0x7E</span><span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">

<p>We now define some unsigned integers as either 8 or 16 bits:</p>
<ul>
<li class="fragment">Variable type: <code>uint16_t</code></li>
<li class="fragment">first variable name: <code>adc_result</code></li>
<li class="fragment">High and low byte of <code>adc_result</code>: <code>adc_result_high</code>, <code>adc_result_low</code></li>
<li class="fragment">second variable name: <code>previous_result</code></li>
<li class="fragment">Initial value of <code>previous_result = 0;</code>”</li>
</ul>
<div class="fragment">
<p>The definitions are:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource c number-lines code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href=""></a><span class="dt">uint16_t</span> adc_result<span class="op">,</span> previous_result <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-2"><a href=""></a><span class="dt">uint8_t</span>  adc_result_low<span class="op">,</span> adc_result_high<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<h3 id="example---the-main-function">Example - the main function</h3>
<p>We discussed this in <a href=".\lectures/week05/#sec-wk5-main-c">Example Code - the main function</a>.</p>
</section>
<section class="slide level2">

<h3 id="example---set-up-io-using-the-registers">Example - set up I/O using the registers</h3>
<div class="sourceCode" id="cb3" data-code-line-numbers="|2|5|8|10|12|14"><pre class="sourceCode numberSource c number-lines code-with-copy"><code class="sourceCode c"><span id="cb3-1"><a href=""></a><span class="co">// Set Data Direction Registers</span></span>
<span id="cb3-2"><a href=""></a>DDRB <span class="op">=</span> DDRB <span class="op">|</span> <span class="bn">0b00111111</span><span class="op">;</span> <span class="co">// Setup bits 0 - 5 of port B as outputs</span></span>
<span id="cb3-3"><a href=""></a></span>
<span id="cb3-4"><a href=""></a><span class="co">// Turn all LEDs off</span></span>
<span id="cb3-5"><a href=""></a>PORTB <span class="op">=</span> PORTB <span class="op">&amp;</span> <span class="bn">0b11000000</span><span class="op">;</span> <span class="co">// Pins B0 (D8) - B5 (D13) start low</span></span>
<span id="cb3-6"><a href=""></a>    </span>
<span id="cb3-7"><a href=""></a><span class="co">// Set up ADC on pin A0</span></span>
<span id="cb3-8"><a href=""></a>DIDR0 <span class="op">=</span> DIDR0 <span class="op">|</span> <span class="bn">0b00000001</span><span class="op">;</span> <span class="co">//Disable pin A0 as a digital input</span></span>
<span id="cb3-9"><a href=""></a>    </span>
<span id="cb3-10"><a href=""></a>ADMUX <span class="op">=</span> <span class="bn">0b01000000</span><span class="op">;</span> <span class="co">// Select reference voltage, right adjusted result and select channel ADC0 - A0</span></span>
<span id="cb3-11"><a href=""></a></span>
<span id="cb3-12"><a href=""></a>ADCSRA <span class="op">=</span> ADCSRA <span class="op">|</span> <span class="bn">0b00000111</span><span class="op">;</span> <span class="co">// Select ADC Prescaler</span></span>
<span id="cb3-13"><a href=""></a></span>
<span id="cb3-14"><a href=""></a>ADCSRA <span class="op">=</span> ADCSRA <span class="op">|</span> <span class="bn">0b10000000</span><span class="op">;</span> <span class="co">// Enable ADC</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">

<h3 id="example---the-processing-loop">Example - the processing loop</h3>
<div class="sourceCode" id="cb4" data-code-line-numbers="|1-15|1|3|5|7|8|11"><pre class="sourceCode numberSource c number-lines code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href=""></a><span class="cf">for</span><span class="op">(;;)</span></span>
<span id="cb4-2"><a href=""></a><span class="op">{</span></span>
<span id="cb4-3"><a href=""></a>    ADCSRA <span class="op">=</span> ADCSRA <span class="op">|</span> <span class="bn">0b01000000</span><span class="op">;</span>         <span class="co">//start conversion by writing 1 to the ADSC bit</span></span>
<span id="cb4-4"><a href=""></a>        </span>
<span id="cb4-5"><a href=""></a>    <span class="cf">while</span><span class="op">((</span>ADCSRA <span class="op">&amp;</span> <span class="bn">0b01000000</span><span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> <span class="op">}</span> <span class="co">//wait until the ADSC bit changes to 0</span></span>
<span id="cb4-6"><a href=""></a></span>
<span id="cb4-7"><a href=""></a>    adc_result_low  <span class="op">=</span> ADCL<span class="op">;</span>     <span class="co">//read the low byte of the result into adc_result_low</span></span>
<span id="cb4-8"><a href=""></a>    adc_result_high <span class="op">=</span> ADCH<span class="op">;</span>     <span class="co">//read the high byte of the result into adc_result_high</span></span>
<span id="cb4-9"><a href=""></a>    <span class="co">/* shift whole 8 bits of ADC high byte into most significant byte of ADC result and </span></span>
<span id="cb4-10"><a href=""></a><span class="co">       add in ADC low byte using bitwise OR. */</span></span>
<span id="cb4-11"><a href=""></a>    adc_result <span class="op">=</span> <span class="op">(</span>adc_result_high<span class="op">&lt;&lt;</span><span class="dv">8</span><span class="op">)</span> <span class="op">|</span> adc_result_low<span class="op">;</span> </span>
<span id="cb4-12"><a href=""></a></span>
<span id="cb4-13"><a href=""></a>    <span class="co">// do somethinhg interesting with the ADC readings</span></span>
<span id="cb4-14"><a href=""></a></span>
<span id="cb4-15"><a href=""></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">

<h3 id="example---the-full-program">Example - the full program</h3>
<p>The full program is available as a GitHub gist: <a href="https://gist.github.com/cpjobling/db5e3e157b6e6153f7cb75157dae1e94">main.c</a>. You will need a fully featured IDE, such as Microchip Studio, to compile and upload the code to the Ardino nano board.</p>
<h3 id="simulation-of-the-full-program">Simulation of the full program</h3>
<blockquote>
<p>Wokwi is an online Electronics simulator. You can use it to simulate Arduino, ESP32, STM32, and many other popular boards, parts and sensors. – <a href="https://docs.wokwi.com/?utm_source=wokwi">Welcome to Wokwi!</a></p>
</blockquote>
<p>My 2024-2025 EG-353 Individual Engineering Project student, Yousef Alsayegh, has created Wokwi simulations of Ben Clifford’s demonstration programs. Here is the simulation of this week’s simulation <a href="https://wokwi.com/projects/413612952684749825">Week 6: Interfacing to analogue I/O with C</a>. You can run the simulation and play with the code.</p>
</section>
<section id="summary" class="slide level2 unnumbered">
<h2>Summary</h2>
<p>In this section we have:</p>
<ul>
<li class="fragment">Discussed the differences between analogue and digital signals and the challenges in working with them.</li>
<li class="fragment">Explored analogue to digital conversion looking at the architectures and focusing on SAR based ADCs.</li>
<li class="fragment">Continued looking at I/O operations on the Atmel ATmega328 microcontroller focusing on analogue signals and using the ADC registers.</li>
</ul>
</section>
<section class="slide level2">

<h3 class="unnumbered" id="on-canvas">On Canvas</h3>
<p>This week on the <a href="https://canvas.swansea.ac.uk/courses/44971/pages/example-program-analogue-to-digital-conversion-with-registers?module_item_id=2258104">canvas course pages</a>, you will find the sample program from today’s lecture, look through this and ensure you are confident in how it works and how the registers are set for analogue inputs and how masks are used for the digital outputs to the LEDS.</p>
<p>There is also a short quiz to test your knowledge on these topics.</p>
</section>
<section class="slide level2">

<h3 class="unnumbered" id="any-questions">Any Questions?</h3>
<p>Please use the <a href="https://canvas.swansea.ac.uk/courses/52902/discussion_topics/435656">Course Question Board</a> on Canvas or take advantage of the lecturers’ office hours.</p>
</section>
<section class="slide level2">

<h3 class="unnumbered" id="next-time">Next time</h3>
<ul>
<li><a href=".\lectures/week07">Introduction to Assembly Language</a></li>
</ul>

</section>

    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="index_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="index_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="index_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="index_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="index_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="index_files/libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="index_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="index_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="index_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="index_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="index_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
            const codeEl = trigger.previousElementSibling.cloneNode(true);
            for (const childEl of codeEl.children) {
              if (isCodeAnnotation(childEl)) {
                childEl.remove();
              }
            }
            return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
            let selectedAnnoteEl;
            const selectorForAnnotation = ( cell, annotation) => {
              let cellAttr = 'data-code-cell="' + cell + '"';
              let lineAttr = 'data-code-annotation="' +  annotation + '"';
              const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
              return selector;
            }
            const selectCodeLines = (annoteEl) => {
              const doc = window.document;
              const targetCell = annoteEl.getAttribute("data-target-cell");
              const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
              const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
              const lines = annoteSpan.getAttribute("data-code-lines").split(",");
              const lineIds = lines.map((line) => {
                return targetCell + "-" + line;
              })
              let top = null;
              let height = null;
              let parent = null;
              if (lineIds.length > 0) {
                  //compute the position of the single el (top and bottom and make a div)
                  const el = window.document.getElementById(lineIds[0]);
                  top = el.offsetTop;
                  height = el.offsetHeight;
                  parent = el.parentElement.parentElement;
                if (lineIds.length > 1) {
                  const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
                  const bottom = lastEl.offsetTop + lastEl.offsetHeight;
                  height = bottom - top;
                }
                if (top !== null && height !== null && parent !== null) {
                  // cook up a div (if necessary) and position it 
                  let div = window.document.getElementById("code-annotation-line-highlight");
                  if (div === null) {
                    div = window.document.createElement("div");
                    div.setAttribute("id", "code-annotation-line-highlight");
                    div.style.position = 'absolute';
                    parent.appendChild(div);
                  }
                  div.style.top = top - 2 + "px";
                  div.style.height = height + 4 + "px";
                  div.style.left = 0;
                  let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
                  if (gutterDiv === null) {
                    gutterDiv = window.document.createElement("div");
                    gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                    gutterDiv.style.position = 'absolute';
                    const codeCell = window.document.getElementById(targetCell);
                    const gutter = codeCell.querySelector('.code-annotation-gutter');
                    gutter.appendChild(gutterDiv);
                  }
                  gutterDiv.style.top = top - 2 + "px";
                  gutterDiv.style.height = height + 4 + "px";
                }
                selectedAnnoteEl = annoteEl;
              }
            };
            const unselectCodeLines = () => {
              const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
              elementsIds.forEach((elId) => {
                const div = window.document.getElementById(elId);
                if (div) {
                  div.remove();
                }
              });
              selectedAnnoteEl = undefined;
            };
              // Handle positioning of the toggle
          window.addEventListener(
            "resize",
            throttle(() => {
              elRect = undefined;
              if (selectedAnnoteEl) {
                selectCodeLines(selectedAnnoteEl);
              }
            }, 10)
          );
          function throttle(fn, ms) {
          let throttle = false;
          let timer;
            return (...args) => {
              if(!throttle) { // first call gets through
                  fn.apply(this, args);
                  throttle = true;
              } else { // all the others get throttled
                  if(timer) clearTimeout(timer); // cancel #2
                  timer = setTimeout(() => {
                    fn.apply(this, args);
                    timer = throttle = false;
                  }, ms);
              }
            };
          }
            const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
            for (let i=0; i<annoteTargets.length; i++) {
              const annoteTarget = annoteTargets[i];
              const targetCell = annoteTarget.getAttribute("data-target-cell");
              const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
              const contentFn = () => {
                const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
                if (content) {
                  const tipContent = content.cloneNode(true);
                  tipContent.classList.add("code-annotation-tip-content");
                  return tipContent.outerHTML;
                }
              }
              const config = {
                allowHTML: true,
                content: contentFn,
                onShow: (instance) => {
                  selectCodeLines(instance.reference);
                  instance.reference.classList.add('code-annotation-active');
                  window.tippy.hideAll();
                },
                onHide: (instance) => {
                  unselectCodeLines();
                  instance.reference.classList.remove('code-annotation-active');
                },
                maxWidth: 300,
                delay: [50, 0],
                duration: [200, 0],
                offset: [5, 10],
                arrow: true,
                appendTo: function(el) {
                  return el.parentElement.parentElement.parentElement;
                },
                interactive: true,
                interactiveBorder: 10,
                theme: 'light-border',
                placement: 'right',
                popperOptions: {
                  modifiers: [
                  {
                    name: 'flip',
                    options: {
                      flipVariations: false, // true by default
                      allowedAutoPlacements: ['right'],
                      fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                    },
                  },
                  {
                    name: 'preventOverflow',
                    options: {
                      mainAxis: false,
                      altAxis: false
                    }
                  }
                  ]        
                }      
              };
              window.tippy(annoteTarget, config); 
            }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>